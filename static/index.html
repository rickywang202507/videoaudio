<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MU Call Processor AI</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>MU CALL PROCESSOR <span
                        style="font-weight: 400; font-size: 0.9rem; margin-left: 10px; opacity: 0.7;">AI ENHANCED
                        v2.0</span></h1>
            </div>
            <div class="actions" style="display: flex; align-items: center;">
                <button id="settingsBtn" class="btn-secondary" style="margin-right: 1rem;" onclick="openSettings()">‚öôÔ∏è
                    Settings</button>
                <button id="templatesBtn" class="btn-secondary" style="margin-right: 1rem;" onclick="openTemplates()">üìù
                    Templates</button>
                <button id="stealthBtn" class="btn-secondary" style="margin-right: 1rem;"
                    onclick="openStealthPanel()">üõ°Ô∏è
                    Stealth Mode</button>
                <select id="aiSelect" class="btn-secondary"
                    style="background: rgba(45, 55, 72, 0.9); color: white; border: 1px solid rgba(255, 255, 255, 0.2); padding: 0.75rem 1rem; border-radius: 12px; margin-right: 1.5rem; cursor: pointer; min-width: 150px; font-weight: 600; appearance: auto;">
                    <!-- Options will be populated -->
                </select>

                <div style="display: flex; align-items: center; margin-right: 1rem;">
                    <input type="checkbox" id="replyToggle" checked style="margin-right: 5px;">
                    <label for="replyToggle"
                        style="color: white; font-size: 0.9rem; font-weight: 600; cursor: pointer;">Enable
                        Auto-Reply</label>
                </div>

                <button id="textNowBtn" class="btn-secondary" style="margin-right: 1rem;" onclick="syncTextNow()">üí¨
                    Sync TextNow</button>
                <button id="historyBtn" class="btn-secondary" style="margin-right: 1rem;"
                    onclick="openReplyHistory()">üìú
                    History</button>
                <button id="manualSendBtn" class="btn-secondary" style="margin-right: 1rem;"
                    onclick="openManualSend()">‚úâÔ∏è
                    Manual Send</button>
                <button id="processBtn" class="btn-primary">Scan & Process Files</button>
            </div>
        </header>

        <!-- Settings Modal -->
        <div id="settingsModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
            <div
                style="background: var(--bg-card); padding: 2rem; border-radius: 20px; width: 600px; max-width: 90%; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(16px);">
                <h2 style="margin-bottom: 1.5rem;">Configuration</h2>

                <div style="margin-bottom: 1rem;">
                    <label
                        style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.8rem;">Video
                        Source Directory (MP4)</label>
                    <input type="text" id="confVideoDir"
                        style="width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: white;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label
                        style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.8rem;">Video
                        Audio Output (MP3)</label>
                    <input type="text" id="confAudioDir"
                        style="width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: white;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label
                        style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.8rem;">Video
                        Transcript Output (TXT/JSON)</label>
                    <input type="text" id="confTxtDir"
                        style="width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: white;">
                </div>
                <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 1.5rem 0;">
                <div style="margin-bottom: 1rem;">
                    <label
                        style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.8rem;">Phone
                        Source Directory (WAV)</label>
                    <input type="text" id="confWavDir"
                        style="width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: white;">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label
                        style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.8rem;">Phone
                        Transcript Output (TXT/JSON)</label>
                    <input type="text" id="confWavTxtDir"
                        style="width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: white;">
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button class="btn-secondary"
                        onclick="document.getElementById('settingsModal').style.display='none'">Cancel</button>
                    <button class="btn-primary" onclick="saveSettings()">Save Configuration</button>
                </div>
            </div>
        </div>

        <!-- Templates Modal -->
        <div id="templatesModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
            <div
                style="background: var(--bg-card); padding: 2rem; border-radius: 20px; width: 900px; max-width: 95%; height: 85vh; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(16px);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">üìù Template Editor</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn-primary" onclick="saveTemplates()">üíæ Save Changes</button>
                        <button class="btn-secondary"
                            onclick="document.getElementById('templatesModal').style.display='none'">‚úï</button>
                    </div>
                </div>

                <div style="display: flex; flex: 1; gap: 2rem; overflow: hidden;">
                    <!-- Left: List -->
                    <div
                        style="width: 250px; border-right: 1px solid rgba(255,255,255,0.1); overflow-y: auto; padding-right: 1rem;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="font-size: 0.9rem; color: var(--text-muted); margin: 0;">Your Templates</h3>
                            <button class="btn-secondary" style="font-size: 0.7rem; padding: 2px 8px;"
                                onclick="addNewTemplate()">‚ûï New</button>
                        </div>
                        <div id="templateList" style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <!-- List items -->
                        </div>
                    </div>

                    <!-- Right: Editor -->
                    <div style="flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding-right: 1rem;">
                        <div id="editorContainer" style="display: none;">
                            <div
                                style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1; margin-right: 1rem;">
                                    <label
                                        style="display: block; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 0.3rem;">Template
                                        Name</label>
                                    <input type="text" id="tplName"
                                        style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.5rem; border-radius: 6px; width: 100%;">
                                </div>
                                <div>
                                    <label
                                        style="display: block; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 0.3rem;">Status</label>
                                    <label
                                        style="display: flex; align-items: center; cursor: pointer; background: rgba(0,0,0,0.2); padding: 0.4rem 0.8rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2);">
                                        <input type="checkbox" id="tplActive" style="margin-right: 0.5rem;">
                                        Set as Active
                                    </label>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; flex: 1;">
                                <div style="flex: 1; display: flex; flex-direction: column;">
                                    <label
                                        style="color: #60a5fa; font-size: 0.8rem; margin-bottom: 0.3rem; font-weight: 600;">Chinese
                                        Content</label>
                                    <textarea id="tplCn"
                                        style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.5rem; border-radius: 6px; flex: 1; font-family: monospace; resize: none;"></textarea>
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column;">
                                    <label
                                        style="color: #f472b6; font-size: 0.8rem; margin-bottom: 0.3rem; font-weight: 600;">English
                                        Content</label>
                                    <textarea id="tplEn"
                                        style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.5rem; border-radius: 6px; flex: 1; font-family: monospace; resize: none;"></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 1rem; display: flex; justify-content: flex-end;">
                                <button class="btn-secondary"
                                    style="color: #fca5a5; border-color: rgba(239, 68, 68, 0.3); font-size: 0.8rem;"
                                    onclick="deleteTemplate()">üóëÔ∏è Delete This Template</button>
                            </div>
                        </div>
                        <div id="emptyEditor"
                            style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                            Select a template to edit
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="file-list" id="fileList">
                <!-- Files will be loaded here -->
            </div>

            <div class="content-area" id="contentArea">
                <div
                    style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
                        stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 1rem; opacity: 0.2;">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <p>Select a file to view details</p>
                </div>
            </div>
        </div>

        <!-- Reply History Modal -->
        <div id="replyHistoryModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
            <div
                style="background: var(--bg-card); padding: 2rem; border-radius: 20px; width: 600px; max-width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(16px);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">üìú Recent Auto-Replies</h2>
                    <button onclick="closeReplyHistory()" class="btn-secondary"
                        style="padding: 0.2rem 0.6rem;">‚úï</button>
                </div>

                <div id="historyList" style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <!-- Items will be loaded here -->
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">Loading history...</div>
                </div>

                <div style="margin-top: 1.5rem; text-align: right;">
                    <button onclick="closeReplyHistory()" class="btn-primary">Close</button>
                </div>
            </div>
        </div>

        <!-- Manual Send Modal -->
        <div id="manualSendModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
            <div
                style="background: var(--bg-card); padding: 2rem; border-radius: 20px; width: 700px; max-width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(16px);">
                <h2 style="margin-bottom: 1.5rem;">üì± Manual Send to TextNow</h2>

                <div style="margin-bottom: 1.5rem;">
                    <label
                        style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">ÈÄâÊã©Ê®°ÊùøÊàñËá™ÂÆö‰πâÊ∂àÊÅØ</label>
                    <select id="templateSelect" onchange="loadTemplate()"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: white; margin-bottom: 1rem;">
                        <option value="">-- Loading Templates... --</option>
                        <!-- Dynamic Options will be loaded here -->
                    </select>
                </div>

                <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <label style="color: var(--text-muted); font-size: 0.9rem;">Ê∂àÊÅØÂÜÖÂÆπ</label>
                    <button id="aiReplyBtn" class="btn-secondary"
                        style="font-size: 0.8rem; padding: 4px 8px; border: 1px solid var(--accent); color: var(--accent);"
                        onclick="generateAiReply()">
                        ü§ñ Generate AI Reply
                    </button>
                </div>
                <textarea id="manualMessage" rows="15"
                    style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: white; font-family: monospace; resize: vertical;"
                    placeholder="Âú®Ê≠§ËæìÂÖ•ÊàñÁºñËæëÊ∂àÊÅØÂÜÖÂÆπ..."></textarea>
                <div style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.8rem;">
                    üí° ÊèêÁ§∫ÔºöËØ∑ÂÖàÂú®Chrome‰∏≠ÈÄâÊã©Ë¶ÅÂèëÈÄÅÁöÑTextNowÂØπËØù
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="closeManualSend()" class="btn-secondary">ÂèñÊ∂à</button>
                <button onclick="sendManualMessage()" class="btn-primary">ÂèëÈÄÅÊ∂àÊÅØ</button>
            </div>
        </div>
    </div>

    <!-- Stealth Mode Panel Modal -->
    <div id="stealthModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div
            style="background: var(--bg-card); padding: 2rem; border-radius: 20px; width: 800px; max-width: 95%; max-height: 85vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(16px);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">üõ°Ô∏è Stealth Mode Control Panel</h2>
                <button onclick="closeStealthPanel()" class="btn-secondary" style="padding: 0.2rem 0.6rem;">‚úï</button>
            </div>

            <!-- Status Section -->
            <div
                style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                <h3 style="margin: 0 0 1rem 0; font-size: 1rem; color: var(--accent);">üìä System Status</h3>
                <div id="stealthStatus" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span id="chromeStatus" style="font-size: 1.5rem;">‚è≥</span>
                        <span style="color: var(--text-muted); font-size: 0.9rem;">Chrome (Port 9222)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span id="stealthLibStatus" style="font-size: 1.5rem;">‚è≥</span>
                        <span style="color: var(--text-muted); font-size: 0.9rem;">selenium-stealth</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span id="stealthScriptStatus" style="font-size: 1.5rem;">‚è≥</span>
                        <span style="color: var(--text-muted); font-size: 0.9rem;">Stealth Scripts</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span id="profileStatus" style="font-size: 1.5rem;">‚è≥</span>
                        <span style="color: var(--text-muted); font-size: 0.9rem;">Stealth Profile</span>
                    </div>
                </div>
                <button onclick="refreshStealthStatus()" class="btn-secondary"
                    style="margin-top: 1rem; font-size: 0.8rem; padding: 0.4rem 0.8rem;">üîÑ Refresh Status</button>
            </div>

            <!-- Actions Section -->
            <div
                style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                <h3 style="margin: 0 0 1rem 0; font-size: 1rem; color: var(--accent);">üéÆ Quick Actions</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button onclick="launchStealthChrome()" class="btn-primary" style="width: 100%;">
                        üöÄ Launch Stealth Chrome
                    </button>
                    <button onclick="runStealthTest()" class="btn-secondary" style="width: 100%;">
                        üß™ Run Detection Test
                    </button>
                    <button onclick="installStealthDeps()" class="btn-secondary" style="width: 100%;">
                        üì¶ Install Dependencies
                    </button>
                    <button onclick="viewStealthLog()" class="btn-secondary" style="width: 100%;">
                        üìÑ View Automation Log
                    </button>
                </div>
            </div>

            <!-- Test Results Section -->
            <div id="testResultsSection"
                style="display: none; background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                <h3 style="margin: 0 0 1rem 0; font-size: 1rem; color: var(--accent);">üß™ Test Results</h3>
                <div id="testResults"
                    style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; white-space: pre-wrap;">
                    Running tests...
                </div>
            </div>

            <!-- Log Viewer Section -->
            <div id="logViewerSection"
                style="display: none; background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                <h3 style="margin: 0 0 1rem 0; font-size: 1rem; color: var(--accent);">üìÑ Automation Log (Last 100
                    lines)</h3>
                <div id="logContent"
                    style="font-family: monospace; font-size: 0.75rem; color: var(--text-muted); max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; white-space: pre-wrap;">
                    Loading log...
                </div>
            </div>

            <!-- Documentation Links -->
            <div
                style="background: rgba(96, 165, 250, 0.1); padding: 1rem; border-radius: 12px; border: 1px solid rgba(96, 165, 250, 0.2);">
                <div style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.5rem;">üìö Documentation</div>
                <div style="color: var(--text-muted); font-size: 0.8rem; line-height: 1.6;">
                    ‚Ä¢ <strong>Quick Start:</strong> QUICK_START.md<br>
                    ‚Ä¢ <strong>Full Guide:</strong> ANTI_BOT_SOLUTION.md<br>
                    ‚Ä¢ <strong>Update Summary:</strong> UPDATE_SUMMARY.md<br>
                    <br>
                    <strong>Important:</strong> After launching Chrome, manually log in to TextNow and complete any
                    verification before running automation.
                </div>
            </div>

            <div style="margin-top: 1.5rem; text-align: right;">
                <button onclick="closeStealthPanel()" class="btn-primary">Close</button>
            </div>
        </div>
    </div>
    </div>

    <script>
        let currentFiles = [];

        async function fetchConfig() {
            const resp = await fetch('/api/config');
            const config = await resp.json();
            const select = document.getElementById('aiSelect');
            select.innerHTML = '';

            Object.keys(config.AI_PROVIDERS).forEach(provider => {
                const opt = document.createElement('option');
                opt.value = provider;
                opt.innerText = `AI: ${provider}`;
                if (provider === config.ACTIVE_AI) opt.selected = true;
                select.appendChild(opt);
            });
        }

        document.getElementById('aiSelect').onchange = async (e) => {
            const active_ai = e.target.value;
            await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ active_ai })
            });
            console.log('AI Provider updated to:', active_ai);
        };

        async function fetchFiles() {
            const resp = await fetch('/api/files');
            currentFiles = await resp.json();
            renderFileList();
        }

        let selectedFileName = null;
        let selectedSourceType = null;

        function renderFileList() {
            const list = document.getElementById('fileList');
            list.innerHTML = `
                <h3 style="margin: 0 0 0.5rem 0.5rem; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">üì± Phone Calls</h3>
                <div id="phoneList"></div>
                <h3 style="margin: 1.5rem 0 0.5rem 0.5rem; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">üé• Video Recordings</h3>
                <div id="videoList"></div>
            `;

            const phoneList = document.getElementById('phoneList');
            const videoList = document.getElementById('videoList');

            // Group by Source -> Date
            const groups = { Phone: {}, Video: {} };

            // Sort files: Urgency first, then timestamp descending
            currentFiles.sort((a, b) => {
                if (!!b.is_urgent !== !!a.is_urgent) return (b.is_urgent ? 1 : 0) - (a.is_urgent ? 1 : 0);
                return (b.timestamp || 0) - (a.timestamp || 0);
            });

            currentFiles.forEach(file => {
                const date = file.file_date || 'Unknown Date';
                if (!groups[file.source_type]) groups[file.source_type] = {};
                if (!groups[file.source_type][date]) groups[file.source_type][date] = [];
                groups[file.source_type][date].push(file);
            });

            const renderGroup = (container, typeGroups) => {
                const dates = Object.keys(typeGroups).sort().reverse();
                if (dates.length === 0) {
                    container.innerHTML = '<div style="padding:10px; opacity:0.5; font-size:0.8rem;">No records found</div>';
                    return;
                }

                dates.forEach(date => {
                    const dateHeader = document.createElement('div');
                    dateHeader.innerText = `üìÖ ${date}`;
                    dateHeader.style.cssText = "background: rgba(255,255,255,0.05); padding: 4px 10px; font-size: 0.75rem; border-radius: 4px; margin: 10px 0 5px 0; font-weight: 600; color: #94a3b8; display: inline-block;";
                    container.appendChild(dateHeader);

                    typeGroups[date].forEach(file => {
                        const item = document.createElement('div');
                        const isActive = file.file_name === selectedFileName && file.source_type === selectedSourceType;

                        let title = file.file_name;
                        let icon = "";
                        let metaInfo = file.detected_language;

                        if (file.is_missed_call) {
                            icon = "üìû ";
                            const phoneStr = file.phone || "Unknown";
                            if (file.call_count > 1) {
                                title = `<span style="color: #f87171;">(${file.call_count})</span> ${phoneStr}`;
                            } else {
                                title = `Missed: ${phoneStr}`;
                            }
                            metaInfo = `<span style="color: var(--text-muted); font-size: 0.75rem;">Aggregated Missed Calls</span>`;
                        }

                        item.className = `file-item ${file.is_urgent ? 'urgent' : ''} ${file.called_back ? 'done' : ''} ${isActive ? 'active' : ''}`;
                        item.innerHTML = `
                            <div class="title">${icon}${title}</div>
                            <div class="meta">
                                ${metaInfo} 
                                ${file.is_urgent ? ' ‚Ä¢ üö® Urgent' : ''} 
                                ${file.called_back ? ' ‚Ä¢ ‚úÖ Done' : ''}
                                ${file.replied ? ' ‚Ä¢ ‚Ü©Ô∏è Replied' : ''}
                            </div>
                        `;
                        item.onclick = () => selectFile(file, item);
                        container.appendChild(item);
                    });
                });
            };

            renderGroup(phoneList, groups.Phone || {});
            renderGroup(videoList, groups.Video || {});
        }

        function selectFile(file, element) {
            selectedFileName = file.file_name;
            selectedSourceType = file.source_type;

            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
            if (element) element.classList.add('active');

            const area = document.getElementById('contentArea');
            area.className = "content-area animate-in";
            area.innerHTML = `
                ${file.is_urgent ? `<div class="urgent-badge">üö® URGENT: ${file.urgency_reason}</div>` : ''}
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h2 style="margin-bottom: 0.5rem;">${file.is_missed_call ? 'üìû Missed Call' : file.file_name}</h2>
                        <div class="meta" style="margin-bottom: 1rem;">
                            ${file.is_missed_call ? `Phone: <span style="color: var(--accent); font-size: 1.1rem; font-weight: 700;">${file.phone || 'Unknown'}</span>` : `Source: ${file.source_type} | Language: ${file.detected_language}`}
                        </div>
                        
                        <div style="display:flex; gap: 1rem;">
                            <!-- Callback Status Toggle -->
                            <div class="status-toggle ${file.called_back ? 'active' : ''}" onclick="toggleCalledBack('${file.file_name}', '${file.source_type}', this, event)">
                                <input type="checkbox" ${file.called_back ? 'checked' : ''}>
                                <label>Mark as Called Back</label>
                            </div>

                            <!-- Replied Status Toggle -->
                            <div class="status-toggle ${file.replied ? 'active' : ''}" style="border-color: ${file.replied ? 'var(--accent)' : 'rgba(255,255,255,0.2)'}" onclick="toggleReplied('${file.file_name}', '${file.source_type}', this, event)">
                                <input type="checkbox" ${file.replied ? 'checked' : ''}>
                                <label>Mark as Replied</label>
                            </div>
                        </div>

                    </div>
                    <div class="actions-group" style="display: flex; gap: 0.5rem; flex-direction: column; align-items: flex-end;">
                         ${!file.is_missed_call ? `
                         <button id="playBtn" class="btn-primary" style="background: var(--success); display: flex; align-items: center; gap: 0.5rem; width: 100%; justify-content: center;" onclick="toggleAudio('/api/audio/${file.source_type}/${encodeURIComponent(file.file_name)}')">
                            <span id="playIcon">‚ñ∂Ô∏è</span> Play Audio
                        </button>` : `
                        <div style="background: rgba(248,113,113,0.1); color: #f87171; padding: 0.5rem; border-radius: 8px; font-size: 0.8rem; border: 1px solid rgba(248,113,113,0.2); width: 100%; text-align: center;">
                            üìû NO VOICEMAIL LEFT
                        </div>
                        `}
                        <div style="display: flex; gap: 0.5rem;">
                            <button id="retryBtn" class="btn-secondary" style="font-size: 0.8rem; padding: 0.5rem 1rem;" onclick="reanalyzeFile('${file.file_name}', '${file.source_type}')">üîÑ Retry AI</button>
                            <button id="deleteBtn" class="btn-secondary" style="font-size: 0.8rem; padding: 0.5rem 1rem; color: #fca5a5; border-color: rgba(239, 68, 68, 0.3);" onclick="deleteRecord('${file.file_name}', '${file.source_type}')">üóëÔ∏è Delete</button>
                        </div>
                        <div style="display: flex; gap: 0.5rem; width: 100%; justify-content: flex-end;">
                            ${file.source_type === 'Video' ? `<button class="btn-secondary" style="font-size: 0.75rem; padding: 0.4rem 0.8rem;" onclick="forceMp4ToMp3('${file.file_name}', '${file.source_type}')">üîÑ MP4‚û°MP3</button>` : ''}
                            ${!file.is_missed_call ? `<button class="btn-secondary" style="font-size: 0.75rem; padding: 0.4rem 0.8rem;" onclick="forceAudioToTxt('${file.file_name}', '${file.source_type}')">üîÑ Audio‚û°TXT</button>` : ''}
                        </div>
                    </div>
                </div>

                <div id="audioContainer" style="display: none; margin-bottom: 2rem; background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                    <audio id="mainAudio" controls style="width: 100%; height: 40px;"></audio>
                </div>

                <div class="section-title">Transcription Summary</div>
                <p style="font-weight: 600; color: var(--accent); margin-bottom: 1rem;">${file.summary}</p>
                
                <div class="section-title">Raw Text</div>
                <div>
                     <!-- Add toggle logic if text is long (> 500 chars) -->
                    <div id="transcript-${file.file_name}" class="transcript-box ${file.text.length > 500 ? 'collapsed' : ''}">${file.text}</div>
                    ${file.text.length > 500 ?
                    `<button class="toggle-btn" onclick="toggleTranscript(this, 'transcript-${file.file_name}')">
                            <span class="icon">üîΩ</span> Show Full Content
                        </button>` : ''
                }
                </div>

                <div class="section-title">AI Suggested Reply</div>
                ${file.source_type === 'Video' ? `
                    <button class="btn-secondary" style="margin-bottom: 1rem;" onclick="document.getElementById('videoReplyBox').style.display='block'; this.style.display='none'">
                        üëÅÔ∏è Show Suggested Reply
                    </button>
                    <div id="videoReplyBox" class="reply-box" style="display: none;">
                ` : `<div class="reply-box">`}
                    <button class="copy-btn btn-secondary" onclick="copyReply()">Copy Content</button>
                    <div id="replyText" style="white-space: pre-wrap;">${file.suggested_reply}</div>
                </div>
            `;
        }

        async function toggleCalledBack(file_name, source_type, container, event) {
            const checkbox = container.querySelector('input');

            // If the user clicked the div but not the checkbox itself, manually toggle the checkbox
            if (event.target !== checkbox) {
                checkbox.checked = !checkbox.checked;
            }

            const newStatus = checkbox.checked;

            try {
                const resp = await fetch('/api/called-back', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_name: file_name,
                        source_type: source_type,
                        status: newStatus
                    })
                });

                if (resp.ok) {
                    if (newStatus) container.classList.add('active');
                    else container.classList.remove('active');

                    // Update local data
                    const file = currentFiles.find(f => f.file_name === file_name && f.source_type === source_type);
                    if (file) {
                        file.called_back = newStatus;
                        // IMPORTANT: Refresh the list to show the cross-out effect
                        renderFileList();
                    }
                } else {
                    checkbox.checked = !newStatus; // Rollback
                    alert('Failed to update status');
                }
            } catch (e) {
                checkbox.checked = !newStatus; // Rollback
                alert('Request failed: ' + e);
            }
        }

        function toggleTranscript(btn, elementId) {
            const el = document.getElementById(elementId);
            const isCollapsed = el.classList.contains('collapsed');

            if (isCollapsed) {
                el.classList.remove('collapsed');
                btn.innerHTML = '<span class="icon">üîº</span> Show Less';
            } else {
                el.classList.add('collapsed');
                btn.innerHTML = '<span class="icon">üîΩ</span> Show Full Content';
            }
        }

        async function forceMp4ToMp3(file_name, source_type) {
            if (!confirm(`Are you sure you want to re-extract MP3 from Video for "${file_name}"?`)) return;

            const btn = document.querySelector('button[onclick*="forceMp4ToMp3"]');
            const originalText = btn ? btn.innerText : 'üîÑ MP4‚û°MP3';
            if (btn) {
                btn.innerText = 'Extracting...';
                btn.disabled = true;
            }

            try {
                const payload = { file_name: file_name, source_type: source_type };
                const resp = await fetch('/api/convert/mp4-to-mp3', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (resp.ok) {
                    alert('MP3 extracted successfully.');
                } else {
                    const err = await resp.json();
                    alert('Error: ' + err.detail);
                }
            } catch (e) {
                alert('Request failed: ' + e);
            } finally {
                if (btn) {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        }

        async function forceAudioToTxt(file_name, source_type) {
            const langChoice = prompt(
                `Re-transcribe "${file_name}"?\n\nEnter language code or leave empty for Auto-Detect:\n- en: English\n- zh: Chinese\n- Empty: Auto`,
                ""
            );

            if (langChoice === null) return; // User cancelled

            const language = langChoice.trim() === "" ? null : langChoice.trim();

            const btn = document.querySelector('button[onclick*="forceAudioToTxt"]');
            const originalText = btn ? btn.innerText : 'üîÑ Audio‚û°TXT';
            if (btn) {
                btn.innerText = 'Transcribing...';
                btn.disabled = true;
            }

            try {
                const payload = {
                    file_name: file_name,
                    source_type: source_type,
                    language: language
                };

                const resp = await fetch('/api/convert/audio-to-txt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (resp.ok) {
                    const updatedFile = await resp.json();
                    // Update local list
                    const idx = currentFiles.findIndex(f => f.file_name === file_name && f.source_type === source_type);
                    if (idx !== -1) currentFiles[idx] = updatedFile;

                    // Refresh list and display
                    renderFileList();
                    const activeItem = document.querySelector(`.file-item.active`);
                    selectFile(updatedFile, activeItem);

                    alert('Re-transcription complete.');
                } else {
                    const err = await resp.json();
                    alert('Error: ' + err.detail);
                }
            } catch (e) {
                alert('Request failed: ' + e);
            } finally {
                if (btn) {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        }

        async function reanalyzeFile(file_name, source_type) {
            const btn = document.getElementById('retryBtn');
            const originalText = btn.innerText;
            btn.innerText = 'Analyzing...';
            btn.disabled = true;

            try {
                const payload = { file_name: file_name, source_type: source_type };
                const resp = await fetch('/api/reanalyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const updatedFile = await resp.json();

                // Update local list
                const idx = currentFiles.findIndex(f => f.file_name === file_name && f.source_type === source_type);
                if (idx !== -1) currentFiles[idx] = updatedFile;

                // Refresh list and display
                renderFileList();
                const activeItem = document.querySelector(`.file-item.active`);
                selectFile(updatedFile, activeItem);

                btn.innerText = 'Success!';
            } catch (e) {
                alert('Analysis failed: ' + e);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function copyReply() {
            const text = document.getElementById('replyText').innerText;
            await navigator.clipboard.writeText(text);
            const btn = document.querySelector('.copy-btn');
            btn.innerText = 'Copied!';
            btn.classList.add('btn-primary');
            setTimeout(() => {
                btn.innerText = 'Copy Content';
                btn.classList.remove('btn-primary');
            }, 2000);
        }

        async function deleteRecord(file_name, source_type) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËÆ∞ÂΩï "${file_name}" ÂèäÂÖ∂ÊâÄÊúâÁõ∏ÂÖ≥Êñá‰ª∂ÔºàËßÜÈ¢ë/Èü≥È¢ë/ÊñáÊú¨ÔºâÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`)) {
                return;
            }

            try {
                const resp = await fetch(`/api/files/${source_type}/${encodeURIComponent(file_name)}`, {
                    method: 'DELETE'
                });

                if (resp.ok) {
                    // Update local list
                    currentFiles = currentFiles.filter(f => !(f.file_name === file_name && f.source_type === source_type));
                    renderFileList();

                    // Clear content area
                    document.getElementById('contentArea').innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                            <p>Record deleted successfully</p>
                        </div>
                    `;
                } else {
                    const error = await resp.json();
                    alert('Delete failed: ' + error.detail);
                }
            } catch (e) {
                alert('Error deleting record: ' + e);
            }
        }

        document.getElementById('processBtn').onclick = async () => {
            const btn = document.getElementById('processBtn');
            btn.innerText = 'Processing...';
            btn.disabled = true;
            try {
                await fetch('/api/process', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'start' }) });
                await fetchFiles();
            } catch (e) {
                alert('Error processing files: ' + e);
            } finally {
                btn.innerText = 'Scan & Process Files';
                btn.disabled = false;
            }
        };

        async function syncTextNow() {
            const btn = document.getElementById('textNowBtn');
            const toggle = document.getElementById('replyToggle');
            const enableReply = toggle.checked;

            const originalText = btn.innerText;
            btn.innerText = 'Launching...';
            btn.disabled = true;
            try {
                const resp = await fetch('/api/sync-textnow', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enable_reply: enableReply })
                });
                const res = await resp.json();
                // alert(res.message); 
                // Don't alert blocking, just log
                console.log(res.message);

                // Visual feedback on button
                btn.innerText = enableReply ? 'Running (Reply ON)' : 'Running (No Reply)';
                setTimeout(() => { btn.innerText = originalText; btn.disabled = false; }, 3000);

            } catch (e) {
                alert("Error: " + e);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function toggleAudio(url) {
            const container = document.getElementById('audioContainer');
            const audio = document.getElementById('mainAudio');
            const playIcon = document.getElementById('playIcon');
            const playBtn = document.getElementById('playBtn');

            if (audio.src.includes(url) && !audio.paused) {
                audio.pause();
                playIcon.innerText = '‚ñ∂Ô∏è';
                playBtn.style.background = 'var(--success)';
            } else {
                if (!audio.src.includes(url)) {
                    audio.src = url;
                }
                audio.play();
                container.style.display = 'block';
                playIcon.innerText = '‚è∏Ô∏è';
                playBtn.style.background = 'var(--primary)';
            }

            audio.onended = () => {
                playIcon.innerText = '‚ñ∂Ô∏è';
                playBtn.style.background = 'var(--success)';
            };
        }

        // Templates Logic
        let allTemplates = {};

        async function fetchTemplates() {
            try {
                const resp = await fetch('/api/templates');
                allTemplates = await resp.json();

                const select = document.getElementById('templateSelect');
                select.innerHTML = '<option value="">-- Select Template --</option>';

                // Sort active first?
                Object.keys(allTemplates).forEach(key => {
                    const t = allTemplates[key];
                    const opt = document.createElement('option');
                    opt.value = key;
                    const activeMark = t.active ? '[ACTIVE] ' : '';
                    opt.innerText = `${activeMark}${t.name || key}`;
                    select.appendChild(opt);
                });

            } catch (e) {
                console.error("Failed to load templates", e);
            }
        }

        function loadTemplate() {
            const select = document.getElementById('templateSelect');
            const key = select.value;
            const textarea = document.getElementById('manualMessage');

            if (!key || !allTemplates[key]) {
                return;
            }

            const t = allTemplates[key];
            const content = `${t.content_cn || ''}\n\n${t.content_en || ''}`;
            textarea.value = content.trim();
        }

        async function generateAiReply() {
            const btn = document.getElementById('aiReplyBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'ü§ñ Thinking...';
            btn.disabled = true;

            const textarea = document.getElementById('manualMessage');

            try {
                const select = document.getElementById('templateSelect');
                const key = select.value;
                let templateContent = "";

                if (key && allTemplates[key]) {
                    const t = allTemplates[key];
                    templateContent = `${t.content_cn || ''}\n\n${t.content_en || ''}`;
                } else {
                    templateContent = textarea.value; // Use current text as base
                }

                const resp = await fetch('/api/generate-reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history_text: "User: Missed call.",
                        template_content: templateContent
                    })
                });

                const data = await resp.json();
                if (data.reply) {
                    textarea.value = data.reply;
                } else {
                    alert("AI returned no reply.");
                }

            } catch (e) {
                alert("AI Error: " + e);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Initial load
        fetchConfig();
        fetchTemplates();
        fetchFiles();

        async function openSettings() {
            const resp = await fetch('/api/config');
            const config = await resp.json();

            document.getElementById('confVideoDir').value = config.VIDEO_DIR;
            document.getElementById('confAudioDir').value = config.AUDIO_DIR;
            document.getElementById('confTxtDir').value = config.TXT_DIR;
            document.getElementById('confWavDir').value = config.WAV_DIR;
            document.getElementById('confWavTxtDir').value = config.WAV_TXT_DIR;

            document.getElementById('settingsModal').style.display = 'flex';
        }

        async function saveSettings() {
            const updates = {
                VIDEO_DIR: document.getElementById('confVideoDir').value,
                AUDIO_DIR: document.getElementById('confAudioDir').value,
                TXT_DIR: document.getElementById('confTxtDir').value,
                WAV_DIR: document.getElementById('confWavDir').value,
                WAV_TXT_DIR: document.getElementById('confWavTxtDir').value,
            };

            try {
                const resp = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                if (resp.ok) {
                    alert('Configuration saved successfully!');
                    document.getElementById('settingsModal').style.display = 'none';
                    // Refresh files as directories might have changed
                    fetchFiles();
                } else {
                    alert('Error saving config');
                }
            } catch (e) {
                alert('Request failed: ' + e);
            }
        }

        // Reply History Functions
        let fullHistory = []; // Store for filtering

        async function openReplyHistory() {
            document.getElementById('replyHistoryModal').style.display = 'flex';
            const list = document.getElementById('historyList');
            list.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">Loading history...</div>';

            try {
                // Add a timestamp to prevent caching
                const resp = await fetch('/api/replied-history?_t=' + new Date().getTime());
                let history = await resp.json();

                if (!Array.isArray(history)) {
                    console.warn("History data is not an array:", history);
                    history = [];
                }

                fullHistory = history; // Store globally for filter

                // Render Search Bar if not exists
                if (!document.getElementById('historySearch')) {
                    const searchContainer = document.createElement('div');
                    searchContainer.style.marginBottom = '1rem';
                    searchContainer.innerHTML = `
                        <input type="text" id="historySearch" placeholder="üîç Search phone number or status..." 
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: white;"
                        onkeyup="filterHistory()">
                    `;
                    // Insert before the list
                    list.parentNode.insertBefore(searchContainer, list);
                } else {
                    document.getElementById('historySearch').value = ''; // Reset
                }

                renderHistoryList(fullHistory);

            } catch (e) {
                list.innerHTML = `<div style="text-align: center; color: #fca5a5; padding: 2rem;">Error loading history: ${e}</div>`;
            }
        }

        function filterHistory() {
            const query = document.getElementById('historySearch').value.toLowerCase();
            const filtered = fullHistory.filter(item =>
                (item.phone && item.phone.toLowerCase().includes(query)) ||
                (item.status && item.status.toLowerCase().includes(query)) ||
                (item.note && item.note.toLowerCase().includes(query))
            );
            renderHistoryList(filtered);
        }

        function renderHistoryList(data) {
            const list = document.getElementById('historyList');
            if (!data || data.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No matching records found.</div>';
                return;
            }

            list.innerHTML = '';

            // Group by Date
            const groups = {};
            data.forEach(item => {
                let dateStr = 'Unknown Date';
                if (item.time) {
                    try {
                        const d = new Date(item.time.replace(/-/g, '/')); // Fix for safari/legacy
                        const today = new Date();
                        const yesterday = new Date();
                        yesterday.setDate(today.getDate() - 1);

                        // Simple day string for comparison
                        const dStr = d.toDateString();
                        const tStr = today.toDateString();
                        const yStr = yesterday.toDateString();

                        if (dStr === tStr) dateStr = 'Today';
                        else if (dStr === yStr) dateStr = 'Yesterday';
                        else dateStr = d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                    } catch (e) { dateStr = item.time.split(' ')[0] || 'Unknown'; }
                }
                if (!groups[dateStr]) groups[dateStr] = [];
                groups[dateStr].push(item);
            });

            // Render Groups
            // Sort keys: Today first, Yesterday second, then dates descending? 
            // Since data is likely already sorted by time DESC, we can just iterate the insertion order if we trust it,
            // OR explicitly sort. Keys iteration order is not guaranteed but usually follows insertion for strings in modern JS if not numeric.
            // Let's use the order appearing in data (which is sorted desc).

            const renderedKeys = new Set();

            // We iterate original data to preserve sorting, and pick the group leader
            data.forEach(item => {
                let dateKey = 'Unknown Date';
                // Same logic to find key
                if (item.time) {
                    try {
                        const d = new Date(item.time.replace(/-/g, '/'));
                        const today = new Date();
                        const yesterday = new Date();
                        yesterday.setDate(today.getDate() - 1);

                        const dStr = d.toDateString();
                        const tStr = today.toDateString();
                        const yStr = yesterday.toDateString();

                        if (dStr === tStr) dateKey = 'Today';
                        else if (dStr === yStr) dateKey = 'Yesterday';
                        else dateKey = d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                    } catch (e) { dateKey = item.time.split(' ')[0] || 'Unknown'; }
                }

                if (!renderedKeys.has(dateKey)) {
                    // Render Header
                    const header = document.createElement('div');
                    header.style.cssText = "font-size: 0.85rem; font-weight: 700; color: #94a3b8; margin: 1.5rem 0 0.5rem 0; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center;";

                    const count = groups[dateKey].length;
                    header.innerHTML = `${dateKey} <span style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 10px; font-weight: 500; color: var(--text-muted);">${count} Replies</span>`;

                    if (list.children.length === 0) header.style.marginTop = '0'; // No margin for first
                    list.appendChild(header);

                    // Render all items for this group
                    groups[dateKey].forEach(gItem => {
                        const el = document.createElement('div');
                        el.style.cssText = "background: rgba(255,255,255,0.03); padding: 0.8rem 1rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; transition: background 0.2s;";
                        el.onmouseover = () => el.style.background = "rgba(255,255,255,0.08)";
                        el.onmouseout = () => el.style.background = "rgba(255,255,255,0.03)";

                        const timeOnly = gItem.time.split(' ')[1] || gItem.time;

                        el.innerHTML = `
                            <div style="display:flex; align-items:center; gap:1rem;">
                                <div style="background: rgba(74, 222, 128, 0.1); color: #4ade80; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">üìû</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 1rem; color: #e2e8f0; font-family: monospace;">${gItem.phone}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${gItem.note || 'Auto-reply sent'}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.75rem; font-weight: 600; color: #4ade80; background: rgba(74, 222, 128, 0.1); padding: 2px 8px; border-radius: 12px; display: inline-block; margin-bottom: 4px;">${gItem.status}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${timeOnly}</div>
                            </div>
                        `;
                        list.appendChild(el);
                    });

                    renderedKeys.add(dateKey);
                }
            });
        }

        function closeReplyHistory() {
            document.getElementById('replyHistoryModal').style.display = 'none';
        }

        // Manual Send Functions 
        const SMS_TEMPLATES = {
            full: `Â∞äÊï¨ÁöÑÊóÖÂÆ¢Ôºå
ÂæàÊä±Ê≠âÊú™ËÉΩÊé•Âê¨ÊÇ®ÁöÑÊù•ÁîµÔºåËØ∑ÂèÇËÄÉ‰ª•‰∏ã‰ø°ÊÅØÔºö
Ë¥≠Á•®ÔºöËØ∑ËÆøÈóÆ‰∏úËà™ÂÆòÁΩë www.ceair.comÔºåÊàñËÅîÁ≥ªÊÇ®ÁöÑ‰ª£ÁêÜ‰∫∫ / Á¨¨‰∏âÊñπÁΩëÁ´ô„ÄÇ
ÈÄÄÊîπÁ•®Ôºö
‚Äì Â¶ÇÂú®‰∏úËà™ÂÆòÁΩëË¥≠Á•®ÔºåËØ∑ÂèëÈÄÅÈÇÆ‰ª∂Ëá≥ MUYVR@chinaeastern.ca
‚Äì ÂÖ∂‰ªñÊ∏†ÈÅìË¥≠Á•®ÔºåËØ∑ËÅîÁ≥ªÂéüË¥≠Á•®Ê∏†ÈÅì„ÄÇ
‰∏≠ËΩ¨ÊúçÂä°Ôºö
https://www.ceair.com/self-service/service-submit/transferService
ÁâπÊÆäÊúçÂä°Áî≥ËØ∑Ôºö
‚Äì Ê∏©Âì•ÂçéÂßãÂèëÔºöMUYVR@chinaeastern.ca
‚Äì Â§ö‰º¶Â§öÂßãÂèëÔºöMUyyzSales@chinaeastern.ca
ÊîπÂêçÊúçÂä°ÔºöËØ∑Ëá¥Áîµ 011 86 21 2069 5530
ÂÖ∂‰ªñ‰∫ãÈ°πÔºöËØ∑ÂèëÈÄÅÈÇÆ‰ª∂Ëá≥ MUyyzSales@chinaeastern.ca or call 011 86 21 2069 5530

ÂÖçË¥£Â£∞ÊòéÔºöÊú¨Áü≠‰ø°‰∏∫Á≥ªÁªüËá™Âä®ÂõûÂ§çÔºå‰ªÖ‰æõÂèÇËÄÉÔºåËØ∑ÊóÖÂÆ¢Ëá™Ë°åÊ†∏ÂÆûÁõ∏ÂÖ≥‰ø°ÊÅØ„ÄÇÊú¨Âè∑Á†ÅÊó†Ê≥ïÊé•Êî∂ÂõûÂ§çÁü≠‰ø°ÔºåÊï¨ËØ∑Ë∞ÖËß£„ÄÇ

Dear Customer,
Sorry we missed your call. Please refer to the information below.

For ticket purchase, please visit China Eastern official website www.ceair.com, or contact your agent / third-party website.

For refund or change:
‚Äì If ticket purchased on China Eastern website, please email MUYVR@chinaeastern.ca

‚Äì Otherwise, please contact original purchase channel.

Transfer service:
https://www.ceair.com/self-service/service-submit/transferService

Special service request:
‚Äì Vancouver departure: MUYVR@chinaeastern.ca

‚Äì Toronto departure: MUyyzSales@chinaeastern.ca

Name change: please call 011 86 21 2069 5530

Other inquiries: please email MUyyzSales@chinaeastern.ca or call 011 86 21 2069 5530

Disclaimer: This is an auto-reply message. Information is for reference only, please verify by yourself. Do not reply to this message, replies cannot be received.`,
            cn: `Â∞äÊï¨ÁöÑÊóÖÂÆ¢Ôºå
ÂæàÊä±Ê≠âÊú™ËÉΩÊé•Âê¨ÊÇ®ÁöÑÊù•Áîµ„ÄÇ
Â¶ÇÈúÄÂ∏ÆÂä©ÔºåËØ∑ÂèëÈÄÅÈÇÆ‰ª∂Ëá≥ MUyyzSales@chinaeastern.ca
ÊàñËá¥Áîµ 011 86 21 2069 5530

Ë∞¢Ë∞¢ÔºÅ`,
            en: `Dear Customer,
Sorry we missed your call.
For assistance, please email MUyyzSales@chinaeastern.ca
or call 011 86 21 2069 5530

Thank you!`
        };

        async function loadTemplatesForDropdown() {
            try {
                // Determine if we need to fetch first? globalTemplates might be empty if we haven't opened the editor.
                if (Object.keys(globalTemplates).length === 0) {
                    const resp = await fetch('/api/templates');
                    globalTemplates = await resp.json();
                }

                const select = document.getElementById('templateSelect');
                select.innerHTML = '<option value="">-- Select Template --</option>';

                Object.keys(globalTemplates).forEach(key => {
                    const tpl = globalTemplates[key];
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.innerText = tpl.name + (tpl.active ? ' (Active)' : '');
                    select.appendChild(opt);
                });

                const customOpt = document.createElement('option');
                customOpt.value = 'custom';
                customOpt.innerText = 'Custom Message';
                select.appendChild(customOpt);

            } catch (e) {
                console.error("Failed to load templates for dropdown", e);
            }
        }

        async function openManualSend() {
            document.getElementById('manualSendModal').style.display = 'flex';

            // Reload templates for dropdown every time we open to be fresh
            await loadTemplatesForDropdown();

            // document.getElementById('templateSelect').value = ''; // Keep default or reset?
            // If we have an active template, maybe select it by default?
            const activeKey = Object.keys(globalTemplates).find(k => globalTemplates[k].active);
            if (activeKey) {
                document.getElementById('templateSelect').value = activeKey;
                // But wait, if we auto-filled from AI suggestion, we shouldn't overwrite it immediately unless user expects it.
                // The logic below checks for suggestion.
            }

            // Auto-fill with AI suggestion from selected file if available
            const textarea = document.getElementById('manualMessage');
            // textarea.value = ''; // Don't reset if we want to default to active template? 
            // Better policy: Try AI suggestion first. If none, try active template.

            let autoFilled = false;

            if (selectedFileName && selectedSourceType) {
                const file = currentFiles.find(f => f.file_name === selectedFileName && f.source_type === selectedSourceType);
                if (file && file.suggested_reply) {
                    textarea.value = file.suggested_reply;
                    autoFilled = true;
                    // document.getElementById('templateSelect').value = 'custom'; // Logic?
                }
            }

            if (!autoFilled && activeKey) {
                loadTemplate(); // Load content of active template
            }
            if (!autoFilled && !activeKey) {
                textarea.value = '';
            }
        }

        async function toggleReplied(file_name, source_type, container, event) {
            const checkbox = container.querySelector('input');
            if (event.target !== checkbox) checkbox.checked = !checkbox.checked;
            const newStatus = checkbox.checked;

            try {
                const resp = await fetch('/api/replied', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_name, source_type, status: newStatus })
                });

                if (resp.ok) {
                    if (newStatus) container.classList.add('active');
                    else container.classList.remove('active');

                    // Update local data
                    const file = currentFiles.find(f => f.file_name === file_name && f.source_type === source_type);
                    if (file) {
                        file.replied = newStatus;
                        renderFileList();
                    }
                } else {
                    checkbox.checked = !newStatus; // Rollback
                    alert('Failed to update status');
                }
            } catch (e) {
                checkbox.checked = !newStatus; // Rollback
                alert('Request failed: ' + e);
            }
        }


        // --- Template Editor Logic ---
        let globalTemplates = {};
        let currentEditingId = null;

        async function openTemplates() {
            document.getElementById('templatesModal').style.display = 'flex';
            await loadTemplatesEditor();
        }

        async function loadTemplatesEditor() {
            try {
                const resp = await fetch('/api/templates');
                globalTemplates = await resp.json();
                renderTemplateList();
            } catch (e) {
                alert('Failed to load templates: ' + e);
            }
        }

        function renderTemplateList() {
            const list = document.getElementById('templateList');
            list.innerHTML = '';

            Object.keys(globalTemplates).forEach(key => {
                const tpl = globalTemplates[key];
                const div = document.createElement('div');
                const isActive = key === currentEditingId;

                div.style.cssText = `
                    padding: 0.8rem; 
                    border-radius: 8px; 
                    background: ${isActive ? 'rgba(255,255,255,0.1)' : 'transparent'}; 
                    border: 1px solid ${isActive ? 'rgba(255,255,255,0.3)' : 'transparent'}; 
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                div.innerHTML = `
                    <div style="font-weight: 600; color: white;">
                        ${tpl.name}
                        ${tpl.active ? '<span style="font-size: 0.7rem; background: var(--success); padding: 2px 6px; border-radius: 4px; margin-left: 5px;">ACTIVE</span>' : ''}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">ID: ${key}</div>
                `;
                div.onclick = () => selectTemplateToEdit(key);
                div.onmouseover = () => { if (!isActive) div.style.background = 'rgba(255,255,255,0.05)'; };
                div.onmouseout = () => { if (!isActive) div.style.background = 'transparent'; };

                list.appendChild(div);
            });
        }

        function selectTemplateToEdit(key) {
            currentEditingId = key;
            const tpl = globalTemplates[key];

            document.getElementById('emptyEditor').style.display = 'none';
            document.getElementById('editorContainer').style.display = 'flex';
            document.getElementById('editorContainer').style.flexDirection = 'column';
            document.getElementById('editorContainer').style.height = '100%';

            document.getElementById('tplName').value = tpl.name || '';
            document.getElementById('tplActive').checked = tpl.active || false;
            document.getElementById('tplCn').value = tpl.content_cn || '';
            document.getElementById('tplEn').value = tpl.content_en || '';

            renderTemplateList(); // Re-render to highlight selection
        }

        function addNewTemplate() {
            const newId = 'custom_' + Date.now();
            globalTemplates[newId] = {
                name: 'New Template ' + new Date().toLocaleTimeString(),
                content_cn: '',
                content_en: '',
                active: false
            };
            renderTemplateList();
            selectTemplateToEdit(newId);
        }

        async function saveTemplates() {
            if (!currentEditingId) return;

            // Update current memory object from inputs
            globalTemplates[currentEditingId].name = document.getElementById('tplName').value;
            globalTemplates[currentEditingId].content_cn = document.getElementById('tplCn').value;
            globalTemplates[currentEditingId].content_en = document.getElementById('tplEn').value;

            const isActive = document.getElementById('tplActive').checked;

            // Logic: If setting to active, must unset others. 
            // If setting to inactive, caution? (At least one should be active usually, but maybe not enforced rigidly)
            if (isActive) {
                Object.keys(globalTemplates).forEach(k => {
                    globalTemplates[k].active = (k === currentEditingId);
                });
            } else {
                globalTemplates[currentEditingId].active = false;
            }

            try {
                const resp = await fetch('/api/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ templates: globalTemplates })
                });

                if (resp.ok) {
                    alert('Templates saved successfully!');
                    renderTemplateList(); // Refresh list to show new active status
                } else {
                    alert('Failed to save templates');
                }
            } catch (e) {
                alert('Error saving: ' + e);
            }
        }

        async function deleteTemplate() {
            if (!currentEditingId) return;
            if (!confirm('Are you sure you want to delete this template?')) return;

            delete globalTemplates[currentEditingId];

            try {
                const resp = await fetch('/api/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ templates: globalTemplates })
                });

                if (resp.ok) {
                    currentEditingId = null;
                    document.getElementById('editorContainer').style.display = 'none';
                    document.getElementById('emptyEditor').style.display = 'flex';
                    renderTemplateList();
                    alert('Template deleted.');
                } else {
                    alert('Failed to delete template on server.');
                }
            } catch (e) {
                alert('Error deleting: ' + e);
            }
        }

        function closeManualSend() {
            document.getElementById('manualSendModal').style.display = 'none';
        }

        function loadTemplate() {
            const select = document.getElementById('templateSelect');
            const textarea = document.getElementById('manualMessage');
            const selectedId = select.value;

            if (selectedId && selectedId !== 'custom') {
                if (globalTemplates[selectedId]) {
                    // Concatenate CN and EN content for manual send
                    const tpl = globalTemplates[selectedId];
                    const content = (tpl.content_cn || '') + '\n\n' + (tpl.content_en || '');
                    textarea.value = content.trim();
                } else if (SMS_TEMPLATES[selectedId]) {
                    // Fallback for hardcoded if valid
                    textarea.value = SMS_TEMPLATES[selectedId];
                }
            } else if (selectedId === 'custom') {
                textarea.value = '';
                textarea.focus();
            }
        }

        async function sendManualMessage() {
            const message = document.getElementById('manualMessage').value.trim();

            if (!message) {
                alert('ËØ∑ËæìÂÖ•Ê∂àÊÅØÂÜÖÂÆπ');
                return;
            }

            if (!confirm('Á°ÆËÆ§ÂèëÈÄÅÊ≠§Ê∂àÊÅØÂà∞ÂΩìÂâçÈÄâ‰∏≠ÁöÑTextNowÂØπËØùÔºü\n\nËØ∑Á°Æ‰øùÂ∑≤Âú®Chrome‰∏≠ÈÄâÊã©‰∫ÜÁõÆÊ†áÂØπËØù„ÄÇ')) {
                return;
            }

            try {
                const resp = await fetch('/api/textnow-manual-send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const result = await resp.json();

                if (resp.ok && result.success) {
                    alert('‚úÖ Ê∂àÊÅØÂèëÈÄÅÊàêÂäüÔºÅ');
                    closeManualSend();

                    if (selectedFileName && selectedSourceType) {
                        fetch('/api/replied', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_name: selectedFileName, source_type: selectedSourceType, status: true })
                        }).then(() => {
                            const file = currentFiles.find(f => f.file_name === selectedFileName && f.source_type === selectedSourceType);
                            if (file) {
                                file.replied = true;
                                renderFileList();
                                const item = document.querySelector('.file-item.active');
                                selectFile(file, item);
                            }
                        });
                    }

                } else {
                    alert('‚ùå ÂèëÈÄÅÂ§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (e) {
                alert('‚ùå ËØ∑Ê±ÇÂ§±Ë¥•: ' + e.message);
            }
        }

        async function generateAiReply() {
            if (!selectedFileName || !selectedSourceType) {
                alert("Please select a file from the list first.");
                return;
            }

            const file = currentFiles.find(f => f.file_name === selectedFileName && f.source_type === selectedSourceType);
            if (!file) return;

            const textarea = document.getElementById('manualMessage');
            textarea.value = "ü§ñ Generating AI reply... please wait.";

            // Get selected template content
            let templateContent = "";
            const select = document.getElementById('templateSelect');
            if (select.value && SMS_TEMPLATES[select.value]) {
                templateContent = SMS_TEMPLATES[select.value];
            } else if (select.value === 'custom') {
                // If custom, maybe use what's in the box? But we just overwrote it.
                // Actually, let's use the active template from globalTemplates if available?
                // For now, empty string implies default logic.
            }

            // Use transcription preview as history proxy if available, or summary
            // Ideally we should fetch the full history, but for now this is a good approximation
            const historyText = (file.transcription_preview || "") + "\n\n" + (file.analysis ? JSON.stringify(file.analysis) : "");

            try {
                const resp = await fetch('/api/generate-reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history_text: historyText,
                        template_content: templateContent
                    })
                });

                const data = await resp.json();
                if (data.reply) {
                    textarea.value = data.reply;
                } else {
                    textarea.value = "Error: No reply generated.";
                }
            } catch (e) {
                textarea.value = "Error generating reply: " + e;
            }
        }
    </script>

    <!-- ==================== STEALTH MODAL (HTML) ==================== -->
    <div id="stealthModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 1.5rem; font-weight: bold; margin: 0;">üõ°Ô∏è Stealth Mode Control Panel</h2>
                <span class="close" onclick="closeStealthPanel()"
                    style="font-size: 2rem; cursor: pointer;">&times;</span>
            </div>

            <!-- Status Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <h3 style="font-weight: bold; margin-bottom: 12px; font-size: 1.1rem;">System Status</h3>
                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.9rem; line-height: 2;">
                        <li style="display: flex; justify-content: space-between;">
                            <span>üöÄ Chrome Running (9222):</span>
                            <span id="chromeStatus" style="font-weight: bold;">Checking...</span>
                        </li>
                        <li style="display: flex; justify-content: space-between;">
                            <span>üì¶ Portable Chrome (v121):</span>
                            <span id="portableStatus" style="font-weight: bold;">Checking...</span>
                        </li>
                        <li style="display: flex; justify-content: space-between;">
                            <span>üìö Selenium-Stealth Lib:</span>
                            <span id="stealthLibStatus" style="font-weight: bold;">Checking...</span>
                        </li>
                    </ul>
                </div>

                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <h3 style="font-weight: bold; margin-bottom: 12px; font-size: 1.1rem;">Components</h3>
                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.9rem; line-height: 2;">
                        <li style="display: flex; justify-content: space-between;">
                            <span>üìÑ Injector Script (.js):</span>
                            <span id="stealthScriptStatus" style="font-weight: bold;">Checking...</span>
                        </li>
                        <li style="display: flex; justify-content: space-between;">
                            <span>üë§ Stealth Profile:</span>
                            <span id="profileStatus" style="font-weight: bold;">Checking...</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Actions -->
            <div style="margin-bottom: 24px;">
                <h3 style="font-weight: bold; margin-bottom: 12px;">Quick Actions</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <!-- Launch Button -->
                    <button onclick="launchStealthChrome()" class="btn-primary"
                        style="display: flex; align-items: center; gap: 8px; background-color: #059669;">
                        <span id="launchBtnText">üöÄ Launch Portable Chrome</span>
                    </button>

                    <!-- Install Portable Button -->
                    <button id="installBtn" onclick="installPortableChrome()" class="btn-primary"
                        style="display: inline-flex; align-items: center; gap: 8px; background-color: #2563eb;">
                        ‚¨áÔ∏è Install Portable (v121)
                    </button>

                    <!-- Fix Deps Button -->
                    <button onclick="installStealthDeps()" class="btn-secondary"
                        style="display: flex; align-items: center; gap: 8px;">
                        üì¶ Fix Dependencies
                    </button>

                    <!-- View Log Button -->
                    <button onclick="viewStealthLog()" class="btn-secondary"
                        style="display: flex; align-items: center; gap: 8px;">
                        üìÑ View Log
                    </button>

                    <!-- Run Test Button -->
                    <button onclick="runStealthTest()" class="btn-secondary"
                        style="display: flex; align-items: center; gap: 8px; background-color: #4b5563; color: white;">
                        üß™ Run Test
                    </button>
                </div>
            </div>

            <!-- Test Results -->
            <div id="testResultsSection" style="margin-bottom: 24px; display: none;">
                <h3 style="font-weight: bold; margin-bottom: 8px;">Test Results</h3>
                <pre id="testResults"
                    style="background: #111827; color: #4ade80; padding: 16px; border-radius: 8px; font-size: 12px; overflow: auto; height: 15rem; font-family: monospace;"></pre>
            </div>

            <!-- Log Viewer Area -->
            <div id="logViewerSection" style="margin-bottom: 24px; display: none;">
                <h3 style="font-weight: bold; margin-bottom: 8px;">Automation Log (Last 100 lines):</h3>
                <pre id="logContent"
                    style="background: #f3f4f6; color: #374151; padding: 16px; border-radius: 8px; font-size: 11px; overflow: auto; height: 15rem; font-family: monospace;"></pre>
            </div>
        </div>
    </div>

    <!-- ==================== STEALTH SCRIPTS ==================== -->
    <script>
        function openStealthPanel() {
            document.getElementById('stealthModal').style.display = 'block';
            refreshStealthStatus();
        }

        function closeStealthPanel() {
            document.getElementById('stealthModal').style.display = 'none';
        }

        async function refreshStealthStatus() {
            try {
                const resp = await fetch('/api/stealth/status');
                const status = await resp.json();

                // Update status indicators (Safe checks)
                const setStatus = (id, valid) => {
                    const el = document.getElementById(id);
                    if (el) el.innerText = valid ? '‚úÖ' : '‚ùå';
                };

                const setStatusText = (id, text) => {
                    const el = document.getElementById(id);
                    if (el) el.innerText = text;
                };

                setStatusText('chromeStatus', status.chrome_running ? '‚úÖ Running' : 'üî¥ Stopped');
                setStatusText('portableStatus', status.has_portable_chrome ? '‚úÖ Installed' : '‚ùå Missing');
                setStatus('stealthLibStatus', status.selenium_stealth_installed);
                setStatus('stealthScriptStatus', status.stealth_script_exists);
                setStatus('profileStatus', status.chrome_profile_stealth_exists);

                // Update Button Text Logic
                const launchBtn = document.getElementById('launchBtnText');
                const installBtn = document.getElementById('installBtn');

                if (launchBtn) {
                    if (status.chrome_running) {
                        launchBtn.innerText = '‚úÖ Chrome Active';
                    } else if (status.has_portable_chrome) {
                        launchBtn.innerText = 'üöÄ Launch Portable Chrome';
                        if (installBtn) installBtn.style.display = 'none';
                    } else {
                        launchBtn.innerText = '‚ö†Ô∏è Launch System Chrome';
                        if (installBtn) installBtn.style.display = 'inline-flex';
                    }
                }

            } catch (e) {
                console.error('[Stealth] Status Error:', e);
            }
        }

        async function launchStealthChrome() {
            const label = document.getElementById('launchBtnText');
            // Ëé∑ÂèñÂÆûÈôÖÁöÑÊåâÈíÆÂÖÉÁ¥†ÔºàÂÆÉÊòØ span ÁöÑÁà∂ÂÖÉÁ¥†Ôºâ
            const btn = label ? label.parentElement : event.target;

            const originalText = label ? label.innerText : btn.innerText;

            if (label) label.innerText = 'Launching...';
            btn.disabled = true;

            try {
                const resp = await fetch('/api/stealth/launch-chrome', { method: 'POST' });
                const result = await resp.json();

                if (result.status === 'success') {
                    alert('‚úÖ Launched!\n\n1. Wait for Chrome\n2. Log in manually\n3. Keep window open');
                    refreshStealthStatus();
                } else if (result.status === 'already_running') {
                    alert('‚ÑπÔ∏è ' + result.message);
                } else {
                    alert('‚ùå ' + result.message);
                }
            } catch (e) {
                alert('Error: ' + e);
            } finally {
                // If not active, revert text
                if (label && !label.innerText.includes('Active')) {
                    label.innerText = originalText;
                }
                btn.disabled = false;
            }
        }

        async function installPortableChrome() {
            if (!confirm("Download Portable Chrome (~150MB)?")) return;
            const btn = document.getElementById('installBtn');
            if (btn) {
                btn.innerText = '‚è≥ Downloading...';
                btn.disabled = true;
            }
            try {
                const resp = await fetch('/api/stealth/install-portable', { method: 'POST' });
                const result = await resp.json();
                alert(result.message);
            } catch (e) { alert(e); }
            finally {
                if (btn) btn.disabled = false;
                refreshStealthStatus(); // Refresh status to update button text
            }
        }

        async function runStealthTest() {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'Testing...';
            btn.disabled = true;

            // Show test results section
            const section = document.getElementById('testResultsSection');
            section.style.display = 'block';
            document.getElementById('testResults').innerText = 'Running anti-detection tests...\n\nThis may take up to 30 seconds.';

            try {
                const resp = await fetch('/api/stealth/test', {
                    method: 'POST'
                });
                const result = await resp.json();

                if (result.status === 'success') {
                    const summary = `Test Complete!\n\nPassed: ${result.passed} ‚úÖ\nFailed: ${result.failed} ‚ùå\n\n--- Full Output ---\n${result.output}`;
                    document.getElementById('testResults').innerText = summary;

                    if (result.failed === 0 && result.passed > 0) {
                        alert('üéâ All tests passed! Your stealth configuration is working correctly.');
                    } else if (result.failed > 0) {
                        alert(`‚ö†Ô∏è Some tests failed (${result.failed}/${result.passed + result.failed}).\n\nCheck the test results for details.`);
                    }
                } else if (result.status === 'timeout') {
                    document.getElementById('testResults').innerText = 'Test timed out after 30 seconds.\n\nMake sure Chrome is running on port 9222.';
                } else {
                    document.getElementById('testResults').innerText = 'Test failed: ' + (result.message || 'Unknown error');
                }
            } catch (e) {
                document.getElementById('testResults').innerText = 'Error running test: ' + e;
                alert('Error running test: ' + e);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function installStealthDeps() {
            if (!confirm('Install selenium-stealth library?\n\nThis will run: pip install selenium-stealth')) {
                return;
            }

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'Installing...';
            btn.disabled = true;

            try {
                const resp = await fetch('/api/stealth/install-deps', {
                    method: 'POST'
                });
                const result = await resp.json();

                if (result.status === 'success') {
                    alert('‚úÖ selenium-stealth installed successfully!\n\n' + result.message);
                    refreshStealthStatus();
                } else if (result.status === 'timeout') {
                    alert('‚è±Ô∏è Installation timed out. Please try manually:\n\npip install selenium-stealth');
                } else {
                    alert('‚ùå Installation failed:\n\n' + result.message + '\n\n' + (result.output || ''));
                }
            } catch (e) {
                alert('Error installing dependencies: ' + e);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function viewStealthLog() {
            const section = document.getElementById('logViewerSection');
            section.style.display = 'block';
            document.getElementById('logContent').innerText = 'Loading log...';

            try {
                const resp = await fetch('/api/stealth/log');
                const result = await resp.json();

                if (result.lines && result.lines.length > 0) {
                    const logText = result.lines.join('');
                    document.getElementById('logContent').innerText = `Total lines: ${result.total_lines}\nShowing last ${result.lines.length} lines:\n\n${logText}`;
                } else {
                    document.getElementById('logContent').innerText = result.message || 'No log data available.';
                }
            } catch (e) {
                document.getElementById('logContent').innerText = 'Error loading log: ' + e;
            }
        }

        // ==================== END STEALTH MODE FUNCTIONS ====================

        // ==================== PAGE INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Page loaded. Initializing...");

            // 1. Load file lists
            if (typeof refreshFiles === 'function') {
                refreshFiles();
            } else {
                console.error("refreshFiles function not found!");
            }

            // 2. Initialize Stealth Status
            if (typeof refreshStealthStatus === 'function') {
                refreshStealthStatus();
            }

            // 3. Setup Template Select Listeners if needed
            const select = document.getElementById('templateSelect');
            if (select) {
                select.addEventListener('change', (e) => {
                    const textarea = document.getElementById('manualMessage');
                    if (e.target.value === 'custom') {
                        textarea.value = "";
                        textarea.placeholder = "Type your custom message here...";
                    } else if (SMS_TEMPLATES[e.target.value]) {
                        textarea.value = SMS_TEMPLATES[e.target.value];
                    }
                });
            }
        });

    </script>
</body>

</html>